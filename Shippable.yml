language: none
#using a custom Docker image

env:
  global:
    - REGISTRY_URL=registry.hub.docker.com
    - IMAGE_REPO=magento2
    - PROJECT_NAME=firadaboss 
    
build:   
    
  pre_ci:
    - docker build -t firadaboss/magento2:latest shippable

  pre_ci_boot:
    image_name: $PROJECT_NAME/$IMAGE_REPO    
    image_tag: latest
    pull: false
#    env: 
#      - MYSQL_HOST=db
#        MYSQL_ROOT_PASSWORD=myrootpassword
#        MYSQL_USER=magento
#        MYSQL_PASSWORD=magento
#        MYSQL_DATABASE=magento
#        
#        MAGENTO_LANGUAGE=en_GB
#        MAGENTO_TIMEZONE=Pacific/Auckland
#        MAGENTO_DEFAULT_CURRENCY=NZD
#        MAGENTO_URL=http://local.magento
#        MAGENTO_BACKEND_FRONTNAME=admin
#        MAGENTO_USE_SECURE=0
#        MAGENTO_BASE_URL_SECURE=0
#        MAGENTO_USE_SECURE_ADMIN=0
#        
#        MAGENTO_ADMIN_FIRSTNAME=Admin
#        MAGENTO_ADMIN_LASTNAME=MyStore
#        MAGENTO_ADMIN_EMAIL=amdin@example.com
#        MAGENTO_ADMIN_USERNAME=admin
#        MAGENTO_ADMIN_PASSWORD=magentorocks1

    options: "-e HOME=/root"

  ci:
    - mv $SHIPPABLE_BUILD_DIR/* $SHIPPABLE_BUILD_DIR/.htaccess /var/www/html
    - chown -R www-data:www-data /var/www
    - su www-data -c "cd $INSTALL_DIR && composer install"
    - su www-data -c "cd $INSTALL_DIR && composer config repositories.magento composer https://repo.magento.com/"  
    - cd /var/www/html 
    - find . -type d -exec chmod 770 {} \;
    - find . -type f -exec chmod 660 {} \;
    - chmod u+x bin/magento    
    - cp shippable/docker/install-magento /usr/local/bin/install-magento
    - chmod +x /usr/local/bin/install-magento
    - cp shippable/docker/install-sampledata /usr/local/bin/install-sampledata
    - chmod +x /usr/local/bin/install-sampledata
    - a2enmod rewrite
    - echo "memory_limit=2048M" > /usr/local/etc/php/conf.d/memory-limit.ini
    - cd /var/www/html

# # Add cron job
    - cp shippable/docker/crontab /etc/cron.d/magento2-cron
    - chmod 0644 /etc/cron.d/magento2-cron 
    - crontab -u www-data /etc/cron.d/magento2-cron    
    
  post_ci:
    #- docker commit $SHIPPABLE_CONTAINER_NAME $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER    
    #- docker push firadaboss/magento2:latest
    #- docker push $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER     
    - docker build -t $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER .    
    - docker push $REGISTRY_URL/$PROJECT_NAME/$IMAGE_REPO:$BRANCH.$BUILD_NUMBER     

  integrations:
    hub:
      - integrationName: docker_integration    #replace with your subscription integration name
        type: dockerRegistryLogin    
        
notifications:
  email: false
